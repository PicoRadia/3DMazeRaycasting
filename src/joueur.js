
var player={x:15.5,y:16.5,direction:0,rotation:0,vertical:0,moveSpeed:.075,rotationSpeed:5,horizontal:!1};function isBlocking(e,a){return a<0||a>=mapHeight||e<0||e>=mapWidth||(0!=map[a>>0][e>>0]||!(!spriteitePosition[a>>0][e>>0]||!spriteitePosition[a>>0][e>>0].block))}function drawRay(e,a){var r=$("objects").getContext("2d");r.strokeStyle="rgba(100,100,100,0.3)",r.lineWidth=.5,r.beginPath(),r.moveTo(player.x*mapScale,player.y*mapScale),r.lineTo(e*mapScale,a*mapScale),r.closePath(),r.stroke()}move=function(e){var a,r,o,i=e/gameCycleDelay;for(player.horizontal?a=i*player.direction*player.moveSpeed:(a=i*player.vertical*player.moveSpeed,player.rotation+=i*player.direction*player.rotationSpeed*Math.PI/180);player.rotation<0;)player.rotation+=2*Math.PI;for(;player.rotation>=2*Math.PI;)player.rotation-=2*Math.PI;player.horizontal?(r=player.x+Math.cos(player.rotation+90*Math.PI/180)*a,o=player.y+Math.sin(player.rotation+90*Math.PI/180)*a):(r=player.x+Math.cos(player.rotation)*a,o=player.y+Math.sin(player.rotation)*a);var t=checkCollision(player.x,player.y,r,o,.35);player.x=t.x,player.y=t.y},checkCollision=function(e,a,r,o,i){var t={x:e,y:a};if(o<0||o>=mapHeight||r<0||r>=mapWidth)return t;var l=r>>0,n=o>>0;if(isBlocking(l,n))return t;t.x=r,t.y=o;var y,c,p=isBlocking(l,n-1),s=isBlocking(l,n+1),h=isBlocking(l-1,n),d=isBlocking(l+1,n);(0!=p&&o-n<i&&(o=t.y=n+i),0!=s&&n+1-o<i&&(o=t.y=n+1-i),0!=h&&r-l<i&&(r=t.x=l+i),0!=d&&l+1-r<i&&(r=t.x=l+1-i),0==isBlocking(l-1,n-1)||0!=p&&0!=h)||(y=r-l)*y+(c=o-n)*c<i*i&&(y*y>c*c?r=t.x=l+i:o=t.y=n+i);0==isBlocking(l+1,n-1)||0!=p&&0!=d||(y=r-(l+1))*y+(c=o-n)*c<i*i&&(y*y>c*c?r=t.x=l+1-i:o=t.y=n+i);0==isBlocking(l-1,n+1)||0!=s&&0!=s||(y=r-l)*y+(c=o-(n+1))*c<i*i&&(y*y>c*c?r=t.x=l+i:o=t.y=n+1-i);0==isBlocking(l+1,n+1)||0!=s&&0!=d||(y=r-(l+1))*y+(c=o-(n+1))*c<i*i&&(y*y>c*c?r=t.x=l+1-i:o=t.y=n+1-i);return t},addKeys=function(){document.onkeydown=function(e){switch((e=e||window.event).keyCode){case 38:player.vertical=1;break;case 40:player.vertical=-1;break;case 16:player.horizontal=!0;break;case 37:player.direction=-1;break;case 39:player.direction=1}},document.onkeyup=function(e){switch((e=e||window.event).keyCode){case 38:case 40:player.vertical=0;break;case 16:player.horizontal=!1;break;case 37:case 39:player.direction=0}}};