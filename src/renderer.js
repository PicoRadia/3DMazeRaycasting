
function initScreen(){var t=$("screen");t.style.height=screenHeight+"px",t.style.width=screenWidth+"px";for(var e=0;e<screenWidth;e+=stripWidth){var i=document.createElement("div");i.style.position="absolute",i.style.left=e+"px",i.style.width=stripWidth+"px",i.style.overflow="hidden";var a=new Image;a.src="src/assets/walls.png",a.style.position="absolute",a.prevStyle={height:0,width:0,top:0,left:0},i.appendChild(a),i.img=a;var s=document.createElement("span");s.style.position="absolute",i.appendChild(s),i.fog=s,screenStrips.push(i),t.appendChild(i)}}var screenWidth=1024,screenHeight=768,screenStrips=[],numoftex=3,stripWidth=2,fov=80*Math.PI/180,numofrays=Math.ceil(screenWidth/stripWidth),viewDist=screenWidth/2/Math.tan(fov/2);updateBackground=function(){$("ceiling").style.backgroundPosition=-200*player.rotation+"px 100%"},castRays=function(){for(var t=0,e=0;e<numofrays;e++){var i=(-numofrays/2+e)*stripWidth,a=Math.sqrt(i*i+viewDist*viewDist),s=Math.asin(i/a);castRay(player.rotation+s,t++)}},castRay=function(t,e){(t%=2*Math.PI)<0&&(t+=2*Math.PI);for(var i,a,s,r,p=t>2*Math.PI*.75||t<2*Math.PI*.25,o=t<0||t>Math.PI,h=0,n=Math.sin(t),l=Math.cos(t),y=0,d=0,c=0,f=n/l,g=p?1:-1,v=g*f,m=p?Math.ceil(player.x):player.x>>0,u=player.y+(m-player.x)*f;m>=0&&m<mapWidth&&u>=0&&u<mapHeight;){if(a=m+(p?0:-1)>>0,s=u>>0,spriteitePosition[s][a]&&!spriteitePosition[s][a].visible&&(spriteitePosition[s][a].visible=!0),map[s][a]>0){y=(w=m-player.x)*w+(W=u-player.y)*W,h=map[s][a],i=u%1,p||(i=1-i),d=m,c=u,r=!0;break}m+=g,u+=v}var x=o?-1:1,M=x*(f=l/n);for(u=o?player.y>>0:Math.ceil(player.y),m=player.x+(u-player.y)*f;m>=0&&m<mapWidth&&u>=0&&u<mapHeight;){if(s=u+(o?-1:0)>>0,a=m>>0,spriteitePosition[s][a]&&!spriteitePosition[s][a].visible&&(spriteitePosition[s][a].visible=!0),map[s][a]>0){var w,W,P=(w=m-player.x)*w+(W=u-player.y)*W;(!y||P<y)&&(y=P,d=m,c=u,h=map[s][a],i=m%1,o&&(i=1-i),r=!1);break}m+=M,u+=x}if(y){var b=screenStrips[e];y=Math.sqrt(y),y*=Math.cos(player.rotation-t);var I=Math.round(viewDist/y),S=I*stripWidth,k=Math.round((screenHeight-I)/2),H=Math.round(i*S),D=b.img.prevStyle;H>S-stripWidth&&(H=S-stripWidth),H+=r?S:0,b.style.height=I+"px",b.style.top=k+"px",b.style.zIndex=I>>0,D.height!=I*numoftex>>0&&(b.img.style.height=I*numoftex>>"0px",D.height=I*numoftex>>0),D.width!=2*S>>0&&(b.img.style.width=2*S>>"0px",D.width=2*S>>0),D.top!=-I*(h-1)>>0&&(b.img.style.top=-I*(h-1)>>"0px",D.top=-I*(h-1)>>0),D.left!=-H&&(b.img.style.left=-H+"px",D.left=-H),b.fog.style.height=I>>"0px",b.fog.style.width=2*S>>"0px",b.fog.style.background="rgba(0,0,0,"+y/10+")"}drawRay(d,c)};